---
title: "Workshop Microbiome Data Analysis - Day 2"
author: "Leyla Kodalci"
output: html_document
---

# A. Install R-packages and load libraries

In this step, we load the required R packages. These libraries provide functions for handling microbiome data (`phyloseq, microbiome`), statistical analyses (`vegan,microbiome`), and visualization (`ggplot2`, `pheatmap,microbiome`).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# install.packages("dplyr")     # To manipulate dataframes
# install.packages("readxl")    # To read Excel files into R
# install.packages("ggplot2")   # for high quality graphics
# install.packages("RColorBrewer")
# BiocManager::install("microbiome")
# BiocManager::install("phyloseq")
# install.packages("pheatmap")
#install.packages("vegan")
#install.packages("ggpubr")

library("phyloseq")
library("dplyr")     # To manipulate dataframes
library("readxl")    # To read Excel files into R
library("ggplot2")   # for high quality graphics
library("RColorBrewer")
library("microbiome")
library("pheatmap")
library("vegan")
library("ggpubr")
```

# B.Import data and set up working environment

We now load the `phyloseq` object created on Day 1. This object contains the OTU table, taxonomy, and sample information. It will be our starting point for exploring microbiome data characteristics.

**! Note: adjust the working directory to load in the data.**
**! Note: adjust the code (e.g. name of phyloseq object) to load in your dataset (ps) **

```{r}

# Load data
path = getwd()

# Load data 
load("phyloseq_object_short.RData")


ps = if (!taxa_are_rows(ps)) t(ps) else ps

# Set clean taxonomy column names (truncate to however many ranks you have)

ranks <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
colnames(tax_table(ps)) <- ranks[seq_len(ncol(tax_table(ps)))]

ps

# Construct count matrix of OTUs/ASVs
otu <- otu_table(ps)
mat <- as.matrix(otu)
if (!taxa_are_rows(ps)) mat <- t(mat)  # ensure rows = OTUs/ASVs, cols = samples

```

**Question:**

What components are included in a `phyloseq` object?

# C. Data_day1 exploration

## 1. Key concepts

### 1.1 Summary measures - OTU level

Let’s begin by summarizing the `phyloseq` object. This gives us an overview of the number of samples, OTUs/ASVs, and taxa. It also shows the range of library sizes (reads per sample), which highlights variability in sequencing depth.

-   The **barplot** shows the distribution of library sizes across samples. This reflects the sequencing depth which varies between samples and can affect downstream analyses. Samples with fewer reads may appear less diverse simply because of lower coverage. This step helps us decide whether filtering or normalization is needed.

-   The function **`summarize_phyloseq()`** gives a quick overview of our dataset (e.g; sequencing depth per sample (min, max, mean), sparsity).

```{r}

# nr of OTUs/ASVs
nr_taxa = ntaxa(ps)
nr_taxa

# nr of Samples
nr_samples = nsamples(ps)
nr_samples

# sample names
names_samples = sample_names(ps)
names_samples

# sample variables
sample_var = sample_variables(ps)
sample_var

# Library sizes
lib_sizes <- sample_sums(ps)
df_lib <- data.frame(Sample = names(lib_sizes), Reads = lib_sizes)

# Barplot of the librarysizes

ggplot(df_lib, aes(x = reorder(Sample, Reads), y = Reads)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "Sample", y = "Total reads", title = "Library sizes per sample")


# Summary measures on reads
summarize_phyloseq(ps)

```

**Questions:**

1.  How many samples and OTUs/ASVs are present in the data?

2.  Are the samples evenly sequenced? What could that mean for downstream comparisons of *raw* counts?

3.  How could we deal with the issue of varying library sizes?

4.  What proportion of the OTU table are zero counts?

5.  If we would agglomerate the OTUs/ASVs on a higher taxonomic level, what changes do you expect for these summary measures?

    -   Compare your answer with results of the code chunck below (1.2)

### 1.2 Summary measures - Genus level

```{r}

# Agglomerate OTUs/ASVs on the genus level
ps_genus = tax_glom(ps,taxrank = "Genus")

# nr of OTUs/ASVs
nr_taxa_genus = ntaxa(ps_genus)
nr_taxa_genus

# nr of Samples
nr_samples_genus = nsamples(ps_genus)
nr_samples_genus

# sample names
names_samples_genus = sample_names(ps_genus)
names_samples_genus

# sample variables
sample_var_genus = sample_variables(ps_genus)
sample_var_genus

# Library sizes
lib_sizes_genus <- sample_sums(ps_genus)
df_genus <- data.frame(Sample = names(lib_sizes_genus), Reads = lib_sizes_genus)

# Barplot of the librarysizes
ggplot(df_genus, aes(x = Sample, y = Reads)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "Sample", y = "Total reads", title = "Library sizes per sample (Genus)")

# Summary measures on reads
print(summarize_phyloseq(ps_genus))
```

### 1.3 Sparsity - OTU level

Microbiome data are typically **sparse**; many OTUs/ASVs are observed in only a few samples. This means our data table has many zeros. Here we check the proportion of zeros to quantify sparsity.

```{r}
# Proportion of zeros overall, per-OTU, per-sample
zero_prop_overall <- mean(mat == 0)
zero_prop_per_OTU <- rowMeans(mat == 0)
zero_prop_per_samp <- colMeans(mat == 0)

zero_prop_overall
summary(zero_prop_per_OTU)
summary(zero_prop_per_samp)

# Quick heatmap of presence/absence (sparse but informative for QC)
pa <- (mat > 0) * 1
pheatmap(pa, show_rownames = TRUE, show_colnames = TRUE,
         main = "Presence/absence heatmap (OTUs/ASVs x samples)")
```

### 1.4 Sparsity - Genus level

```{r}

# Construct count matrix of Genera
otu_genus <- otu_table(ps_genus)
mat_genus <- as.matrix(otu_genus)
if (!taxa_are_rows(ps_genus)) mat_genus <- t(mat_genus)  # ensure rows = OTUs/ASVs, cols = samples

# Proportion of zeros overall, per-OTU, per-sample
zero_prop_overall <- mean(mat_genus == 0)
zero_prop_per_gen <- rowMeans(mat_genus == 0)
zero_prop_per_samp <- colMeans(mat_genus == 0)

zero_prop_overall
summary(zero_prop_per_gen)
summary(zero_prop_per_samp)

# Quick heatmap of presence/absence (sparse but informative for QC)
pa_genus <- (mat_genus > 0) * 1
pheatmap(pa_genus, show_rownames = TRUE, show_colnames = TRUE,
         main = "Presence/absence heatmap (Genera x samples)")
```

**Questions**

1.  Is sparsity high in this dataset? Which summary above tells you that?
2.  In the heatmaps, do you see groups of samples that share many present/absent OTUs/ASVs (i.e., cluster together)?
3.  What is the difference in sparsity on OTU level and Genus level?
4.  Why might sparsity motivate filtering rare OTUs/ASVs?

### 1.5 Library size vs % zeros

Here we examine the relationship between **library size** and **sparsity** (% zeros per sample). Samples with fewer reads are more likely to be sparse, because rare taxa are less likely to be detected. This helps us understand whether sparsity is a biological signal or a technical artifact.

```{r}
qc <- data.frame(
  Sample = colnames(mat),
  Reads = sample_sums(ps),
  PctZero = colMeans(mat == 0) * 100
)

ggplot(qc, aes(Reads, PctZero)) +
  geom_point() +
  labs(x = "Reads", y = "% zeros", title = "prop zeros vs library size") +
  theme_bw()
```

**Questions**

1.  Do you see a trend that lower-depth samples have more zeros?
2.  Would you consider excluding any extreme outliers before diversity analysis?

### 1.6 Overdispersion (mean-variance)

Another important property is overdispersion: the variance across samples is often larger than the mean for a given OTU. If counts followed a simple Poisson distribution, the variance would equal the mean (points would fall on the diagonal line).

```{r}
# Compute per OTU mean and variance across samples
OTU_mean <- rowMeans(mat)
OTU_var  <- apply(mat, 1, var)

mv <- data.frame(mean = OTU_mean, var = OTU_var)
mv <- subset(mv, mean > 0)  # drop OTUs/ASVs with zero mean (all zeros)

#Plot in log–log space with Poisson line (y = x)

ggplot(mv, aes(x = mean, y = var)) +
  geom_point(size = 1.6, alpha = 0.8) +
  geom_abline(slope = 1, intercept = 0, linetype = 1) +  # var = mean
  scale_x_log10() + scale_y_log10() +
  labs(title = "Overdispersion check (variance vs mean)",
       x = "Mean counts per OTU (log10)",
       y = "Variance across samples (log10)") 
```

**Questions:**

1.  Why do most points in the mean-variance plot lie above the Poisson line?

2.  Why might microbial data show such high variability across samples?

3.  What is the implication of strong overdispersion for statistical testing if we incorrectly used Poisson models?

## 2. Explore taxonomic compositions and abundances

We now move from individual OTUs/ASVs to higher-level taxonomy. Aggregating to the **Phylum** level makes patterns easier to interpret biologically. To compare across samples with varying library sizes, we transform the read counts to relative abundances. This highlights composition rather than depth.

### 2.1 Phylum level

```{r}

#Get count of phyla

table(tax_table(ps)[, "Phylum"])

# Transform to relative abundances

ps_rel= transform_sample_counts(ps, function(x){x / sum(x)})

# Stacked bars: raw counts

plot_bar(ps, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Read Counts\n") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

# Stacked bars: relative abundance

plot_bar(ps_rel, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())


```

**Questions:**

1.  How do the counts vs relative plots differ visually? Which is better for between-sample comparison and why?
2.  What is lost when switching from counts to relative abundances?
3.  Which phyla appear most dominant on average?
4.  What’s one visual improvement you’d make?

### 2.2 Genus level

We can also **collapse OTUs/ASVs** to a chosen taxonomic level (e.g., Genus). This reduces dimensionality and simplifies interpretation but comes at the cost of resolution.

-   We subset to a dominant phyla (example: **Pseudomonadota**)

-   convert to percentages

-   agglomerate to Genus and lump rare genera to reduce clutter.

```{r}

# Take a subset of an dominant Phyla and explore further

Pseudomonadota <- subset_taxa(ps, Phylum == "Pseudomonadota")

ps_rel_phyl = transform_sample_counts(Pseudomonadota, function(x){x*100 / sum(x)})

Pseudomonadota_glom <- tax_glom(ps_rel_phyl, taxrank = "Genus")
Pseudomonadota_df <- psmelt(Pseudomonadota_glom )

# # Lump small genera (<10% in any sample) to clarify the plot
Pseudomonadota_df$Genus[Pseudomonadota_df$Abundance < 10] <- "Genera < 10.0 abund"
Pseudomonadota_df$Genus <- as.factor(Pseudomonadota_df$Genus)

# Color Palette sized to the number of genera
genus_colors_Pseudomonadota<- colorRampPalette(brewer.pal(8,"Dark2")) (length(levels(Pseudomonadota_df$Genus)))  

# Stacked bars at Genus level
plot_Pseudomonadota<- ggplot(data=Pseudomonadota_df, aes(x=Sample, y=Abundance, fill=Genus))+ geom_bar(aes(), stat="identity", position="stack")+
    scale_fill_manual(values = genus_colors_Pseudomonadota)

plot_Pseudomonadota
```

**Questions:**

1.  Explore the composition plot. What did we do to make it visually more clear? (Hint: also check the code)

2.  What are the pros and cons of collapsing to Genus level?

### 2.3 Prevalence–abundance landscape

Instead of focusing only on abundance, we can also measure **prevalence**: in how many samples a taxon is observed. High-prevalence taxa are often “core microbiome” members, while low-prevalence taxa may be contaminants or rare species. This scatterplot helps select a sensible low-prevalence filter.

```{r}

# Storing original relative abundances

otu_rel <- as(otu_table(ps_rel), "matrix")
if (!taxa_are_rows(ps_rel)) otu_rel <- t(otu_rel)

# Calculate prevalence and mean relative abundance
prev <- rowMeans(mat > 0)
mean_rel <- rowMeans(otu_rel)

prev_abund <- data.frame(prevalence = prev, mean_rel_abund = mean_rel)

ggplot(prev_abund, aes(prevalence, mean_rel_abund)) +
  geom_point(alpha = 0.5) +
  scale_y_log10() +
  labs(x = "Prevalence (fraction of samples)",
       y = "Mean relative abundance (log10)",
       title = "Prevalence–abundance landscape")

# Example: keep taxa present in at least 5% of samples
keep <- rowSums(mat > 0) >= ceiling(0.05 * nsamples(ps))
ps_filt <- prune_taxa(keep, ps)
ps_filt
```

**Questions**

1.  Where do most taxa lie on the plot, low prevalence, low abundance? What filter seems reasonable here?
2.  How could an overly aggressive filter bias downstream analyses?

### 2.3.1 Core microbiome (by detection & prevalence)

By combining prevalence and abundance, we can define a **core microbiome**: taxa consistently present across a large fraction of samples. This concept helps identify stable members of the community.

```{r}

core_ids <- core_members(ps_rel, detection = 0.001, prevalence = 0.5)  # ≥0.1% in ≥50% samples
length(core_ids); head(core_ids)

ps_core <- prune_taxa(core_ids, ps_rel)
plot_bar(ps_core, fill = "Phylum") +
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(title = "Core taxa (≥0.1% & ≥50% prevalence)")
```

**Questions**

1.  How many "core" taxa do you get? Which phyla dominate among core taxa?
2.  How might core membership change if you tighten/loosen thresholds? (Try it out by adjusting the code above.)
3.  Why is identifying a core microbiome useful in applied microbiome research (e.g., health, agriculture)?

### 2.4 Top‑N genera view (lump the rest)

Instead of showing all genera, we can focus on the **Top-N most abundant genera** (e.g., Top-10 or Top-20). This makes visualizations clearer and highlights dominant community members, while still illustrating diversity. Rare genera are often grouped into “Other.”

```{r}
set.seed(1)
ps_genus_rel = transform_sample_counts(ps_genus, function(x){x / sum(x)})
dfg <- psmelt(ps_genus_rel)

# Clean empty/NA genus labels
dfg$Genus <- as.character(dfg$Genus)
dfg$Genus[is.na(dfg$Genus) | dfg$Genus == ""] <- "Unclassified"

# Pick top N by mean abundance
topN <- 15
Top <- dfg %>%
  group_by(Genus) %>%
  summarize(mean_abund = mean(Abundance), .groups = "drop") %>%
  arrange(desc(mean_abund)) %>%
  slice_head(n = topN)

dfg$Genus2 <- ifelse(dfg$Genus %in% Top$Genus, dfg$Genus, "Other")

# Optional: order samples by a metadata variable if present (replace 'Group')
# md <- data.frame(sample_data(ps)); md$Sample <- rownames(md)
# ord <- md %>% arrange(Group) %>% pull(Sample)
# dfg$Sample <- factor(dfg$Sample, levels = ord)

ggplot(dfg, aes(x = Sample, y = Abundance, fill = Genus2)) +
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(y = "Relative abundance", title = paste("Top", topN, "genera (others lumped)"))
```

**Questions**

1.  Which genera dominate across samples?
2.  Why might we group rare taxa into “Other” when plotting?
3.  Try different `topN` values, what changes?

### 2.5 Prevalence Filtering

Filtering reduces the number of very rare OTUs/ASVs (potentially spurious) without affecting the abundant taxa that drive community patterns.

```{r}
prevdf = data.frame(Prevalence = prev,
                      TotalAbundance = taxa_sums(ps),
                      tax_table(ps))

prevdf1 = subset(prevdf, Phylum %in% get_taxa_unique(ps, "Phylum"))
ggplot(prevdf1, aes(TotalAbundance, Prevalence / nsamples(ps),color=Phylum)) +
  # Include a guess for parameter
  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) + geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() +  xlab("Total Abundance") + ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Phylum) + theme(legend.position="none")

ps_filt <- filter_taxa(ps, function(x) {
  sum(x > 0) > (0.05 * nsamples(ps)) & sum(x) > 50
}, TRUE)

ps_filt

## --- 1) Define a filtering rule (tweak thresholds as you like)
prev_cut   <- 0.05            # keep taxa present in >5% of samples
abund_cut  <- 50              # keep taxa with >50 total reads across all samples

ps_filt <- filter_taxa(ps, function(x) {
  (sum(x > 0) > prev_cut * nsamples(ps)) & (sum(x) > abund_cut)
}, prune = TRUE)

## --- 2) Quick summary: what did we remove?
n_OTU_before <- ntaxa(ps)
n_OTU_after <- ntaxa(ps_filt)
reads_before <- sum(sample_sums(ps))
reads_after <- sum(sample_sums(ps_filt))

cat(sprintf("OTUs/ASVs: %d → %d (removed %d, %.1f%%)\n",
            n_OTU_before, n_OTU_after, n_OTU_before - n_OTU_after,
            100*(n_OTU_before - n_OTU_after)/n_OTU_before))

cat(sprintf("Reads kept: %.1f%% of total\n", 100*reads_after/reads_before))

## --- 3) Prepare BEFORE & AFTER relative-abundance data at Phylum
to_rel <- function(x) transform_sample_counts(x, function(y) y / sum(y))
ps_rel_before <- tax_glom(to_rel(ps),      taxrank = "Phylum")
ps_rel_after  <- tax_glom(to_rel(ps_filt), taxrank = "Phylum")

df_before <- psmelt(ps_rel_before) %>% mutate(Status = "Before filtering")
df_after  <- psmelt(ps_rel_after)  %>% mutate(Status = "After filtering")

# ## (Optional) collapse very small phyla into "Other" to declutter plots
# min_prop <- 0.01  # show phyla with >=1% mean relative abundance
# keep_phyla <- df_before %>%
#   group_by(Phylum) %>% summarize(meanAbund = mean(Abundance, na.rm=TRUE)) %>%
#   filter(meanAbund >= min_prop) %>% pull(Phylum)
# collapse_small <- function(d) d %>%
#   mutate(Phylum = ifelse(Phylum %in% keep_phyla, as.character(Phylum), "Other"))
# 
# df_before <- collapse_small(df_before)
# df_after  <- collapse_small(df_after)

plot_df <- bind_rows(df_before, df_after)

## --- 4) Side-by-side composition plots (relative abundance by Phylum)
ggplot(plot_df, aes(x = Sample, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ Status, ncol = 2, scales = "free_x") +
  labs(x = NULL, y = "Relative abundance", title = "Taxonomic composition at Phylum level: Before vs After filtering") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right")
```

```{r}
# Function to create rank abundance dataframe
make_rank_df <- function(ps, label) {
  df <- data.frame(Abundance = taxa_sums(ps)) %>%
    arrange(desc(Abundance)) %>%
    mutate(Rank = 1:n(),
           Dataset = label)
  return(df)
}

# Create rank-abundance data before and after filtering
rank_before <- make_rank_df(ps, "Before filtering")
rank_after  <- make_rank_df(ps_filt, "After filtering")

rank_df <- rbind(rank_before, rank_after)

# Plot rank-abundance curve
ggplot(rank_df, aes(x = Rank, y = Abundance, color = Dataset)) +
  geom_point(size = 1.2, alpha = 0.7) +
  scale_y_log10() +
  scale_x_log10() +
  labs(title = "Rank-Abundance Curves (Before vs After Filtering)",
       x = "Rank (log scale)",
       y = "Abundance (log scale)") +
  theme_minimal()
```

**Questions:**

1.  Which phyla contain OTUs/ASVs with high prevalence (present in many samples) and high abundance?

2.  Which phyla appear mostly as low-abundance, low-prevalence OTUs/ASVs?

3.  If you had to choose a cutoff for filtering, which regions of this plot would you target?

4.  Why might it be safe to remove rare OTUs/ASVs from low-prevalence phyla, but risky to remove abundant, prevalent OTUs/ASVs?

5.  What do you notice about the beginning of the curve (low-rank OTUs/ASVs, high abundance)?

6.  Where do the “before” and “after filtering” lines diverge?

7.  What does this suggest about which OTUs/ASVs were removed?

8.  Do you think filtering changed the dominant community structure? Why or why not?



3. Explore Diversity

Compute alpha diversity (e.g., Observed richness, Shannon) on filtered data. Visualize alpha diversity across groups using violin/box plots with jitter. Explore beta diversity using distance measures (e.g., Bray–Curtis, Aitchison after CLR) and simple ordinations (e.g., PCoA), with clear legends and minimal preprocessing surprises.

Tip: Use the filtered object ps_filt (from D1) or a lightly filtered variant for diversity to reduce noise from ultra-rare taxa, and prefer relative/CLR transforms where appropriate for distance metrics sensitive to compositionality.

```{r}
aplha_ind <- microbiome::alpha(ps, index = "all")
print(head(aplha_ind))

# Alpha diversity by FoodType
plot_richness(ps, , measures = c("Observed", "Shannon")) +
  geom_boxplot(aes(), alpha = 0.5) +
  theme_bw()
```


# D. Data_food exploration

## 1. Key concepts

### 1.1 Summary measures - OTU level

Let’s begin by summarizing the `phyloseq` object. This gives us an overview of the number of samples, OTUs/ASVs, and taxa. It also shows the range of library sizes (reads per sample), which highlights variability in sequencing depth.

-   The **barplot** shows the distribution of library sizes across samples. This reflects the sequencing depth which varies between samples and can affect downstream analyses. Samples with fewer reads may appear less diverse simply because of lower coverage. This step helps us decide whether filtering or normalization is needed.

-   The function **`summarize_phyloseq()`** gives a quick overview of our dataset (e.g; sequencing depth per sample (min, max, mean), sparsity).

```{r}

# Load the data 
load("food.RData")

ps = food

ps = if (!taxa_are_rows(ps)) t(ps) else ps

# Set clean taxonomy column names (truncate to however many ranks you have)

ranks <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")
colnames(tax_table(ps)) <- ranks[seq_len(ncol(tax_table(ps)))]

ps

# Construct count matrix of OTUs/ASVs
otu <- otu_table(ps)
mat <- as.matrix(otu)
if (!taxa_are_rows(ps)) mat <- t(mat) 

# nr of OTUs/ASVs
nr_taxa = ntaxa(ps)
nr_taxa


# nr of Samples
nr_samples = nsamples(ps)
nr_samples

# sample names
names_samples = sample_names(ps)
names_samples

# sample variables
sample_var = sample_variables(ps)
sample_var

# Library sizes
lib_sizes <- sample_sums(ps)
df_lib <- data.frame(Sample = names(lib_sizes), Reads = lib_sizes)

# Barplot of the librarysizes

ggplot(df_lib, aes(x = reorder(Sample, Reads), y = Reads)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "Sample", y = "Total reads", title = "Library sizes per sample")


# Summary measures on reads
summarize_phyloseq(ps)

```

**Questions:**

1.  How many samples and OTUs/ASVs are present in the data?

2.  Are the samples evenly sequenced? What could that mean for downstream comparisons of *raw* counts?

3.  How could we deal with the issue of varying library sizes?

4.  What proportion of the OTU table are zero counts?

5.  If we would agglomerate the OTUs/ASVs on a higher taxonomic level, what changes do you expect for these summary measures?

    -   Compare your answer with results of the code chunck below (1.2)

### 1.2 Summary measures - Genus level

```{r}

# Agglomerate OTUs/ASVs on the genus level
ps_genus = tax_glom(ps,taxrank = "Genus")

# nr of OTUs/ASVs
nr_taxa_genus = ntaxa(ps_genus)
nr_taxa_genus

# nr of Samples
nr_samples_genus = nsamples(ps_genus)
nr_samples_genus

# sample names
names_samples_genus = sample_names(ps_genus)
names_samples_genus

# sample variables
sample_var_genus = sample_variables(ps_genus)
sample_var_genus

# Library sizes
lib_sizes_genus <- sample_sums(ps_genus)
df_genus <- data.frame(Sample = names(lib_sizes_genus), Reads = lib_sizes_genus)

# Barplot of the librarysizes
ggplot(df_genus, aes(x = Sample, y = Reads)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x = "Sample", y = "Total reads", title = "Library sizes per sample (Genus)")

# Summary measures on reads
print(summarize_phyloseq(ps_genus))
```

### 1.3 Sparsity - OTU level

Microbiome data are typically **sparse**; many OTUs/ASVs are observed in only a few samples. This means our data table has many zeros. Here we check the proportion of zeros to quantify sparsity.

```{r}
# Proportion of zeros overall, per-OTU, per-sample
zero_prop_overall <- mean(mat == 0)
zero_prop_per_OTU <- rowMeans(mat == 0)
zero_prop_per_samp <- colMeans(mat == 0)

zero_prop_overall
summary(zero_prop_per_OTU)
summary(zero_prop_per_samp)

# Quick heatmap of presence/absence (sparse but informative for QC)
pa <- (mat > 0) * 1
pheatmap(pa, show_rownames = TRUE, show_colnames = TRUE,
         main = "Presence/absence heatmap (OTUs/ASVs x samples)")
```

### 1.4 Sparsity - Genus level

```{r}

# Construct count matrix of Genera
otu_genus <- otu_table(ps_genus)
mat_genus <- as.matrix(otu_genus)
if (!taxa_are_rows(ps_genus)) mat_genus <- t(mat_genus)  # ensure rows = OTUs/ASVs, cols = samples

# Proportion of zeros overall, per-OTU, per-sample
zero_prop_overall <- mean(mat_genus == 0)
zero_prop_per_gen <- rowMeans(mat_genus == 0)
zero_prop_per_samp <- colMeans(mat_genus == 0)

zero_prop_overall
summary(zero_prop_per_gen)
summary(zero_prop_per_samp)

# Quick heatmap of presence/absence (sparse but informative for QC)
pa_genus <- (mat_genus > 0) * 1
pheatmap(pa_genus, show_rownames = TRUE, show_colnames = TRUE,
         main = "Presence/absence heatmap (Genera x samples)")
```

**Questions**

1.  Is sparsity high in this dataset? Which summary above tells you that?
2.  In the heatmaps, do you see groups of samples that share many present/absent OTUs/ASVs (i.e., cluster together)?
3.  What is the difference in sparsity on OTU level and Genus level?
4.  Why might sparsity motivate filtering rare OTUs/ASVs?

### 1.5 Library size vs % zeros

Here we examine the relationship between **library size** and **sparsity** (% zeros per sample). Samples with fewer reads are more likely to be sparse, because rare taxa are less likely to be detected. This helps us understand whether sparsity is a biological signal or a technical artifact.

```{r}
qc <- data.frame(
  Sample = colnames(mat),
  Reads = sample_sums(ps),
  PctZero = colMeans(mat == 0) * 100
)

ggplot(qc, aes(Reads, PctZero)) +
  geom_point() +
  labs(x = "Reads", y = "% zeros", title = "prop zeros vs library size") +
  theme_bw()
```

**Questions**

1.  Do you see a trend that lower-depth samples have more zeros?
2.  Would you consider excluding any extreme outliers before diversity analysis?

### 1.6 Overdispersion (mean-variance)

Another important property is overdispersion: the variance across samples is often larger than the mean for a given OTU. If counts followed a simple Poisson distribution, the variance would equal the mean (points would fall on the diagonal line).

```{r}
# Compute per OTU mean and variance across samples
OTU_mean <- rowMeans(mat)
OTU_var  <- apply(mat, 1, var)

mv <- data.frame(mean = OTU_mean, var = OTU_var)
mv <- subset(mv, mean > 0)  # drop OTUs/ASVs with zero mean (all zeros)

#Plot in log–log space with Poisson line (y = x)

ggplot(mv, aes(x = mean, y = var)) +
  geom_point(size = 1.6, alpha = 0.8) +
  geom_abline(slope = 1, intercept = 0, linetype = 1) +  # var = mean
  scale_x_log10() + scale_y_log10() +
  labs(title = "Overdispersion check (variance vs mean)",
       x = "Mean counts per OTU (log10)",
       y = "Variance across samples (log10)") 
```

**Questions:**

1.  Why do most points in the mean-variance plot lie above the Poisson line?

2.  Why might microbial data show such high variability across samples?

3.  What is the implication of strong overdispersion for statistical testing if we incorrectly used Poisson models?

## 2. Explore taxonomic compositions and abundances

We now move from individual OTUs/ASVs to higher-level taxonomy. Aggregating to the **Phylum** level makes patterns easier to interpret biologically. To compare across samples with varying library sizes, we transform the read counts to relative abundances. This highlights composition rather than depth.

### 2.1 Phylum level

```{r}

#Get count of phyla

table(tax_table(ps)[, "Phylum"])

# Transform to relative abundances

ps_rel= transform_sample_counts(ps, function(x){x / sum(x)})

# Stacked bars: raw counts

plot_bar(ps, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Read Counts\n") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

# Stacked bars: relative abundance

plot_bar(ps_rel, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())


```

**Questions:**

1.  How do the counts vs relative plots differ visually? Which is better for between-sample comparison and why?
2.  What is lost when switching from counts to relative abundances?
3.  Which phyla appear most dominant on average?
4.  What’s one visual improvement you’d make?

### 2.2 Genus level

We can also **collapse OTUs/ASVs** to a chosen taxonomic level (e.g., Genus). This reduces dimensionality and simplifies interpretation but comes at the cost of resolution.

-   We subset to a dominant phyla (example: **Firmicutes**)

-   convert to percentages

-   agglomerate to Genus and lump rare genera to reduce clutter.

```{r}

# Take a subset of an dominant Phyla and explore further

Firmicutes <- subset_taxa(ps, Phylum == "p__Firmicutes")

ps_rel_phyl = transform_sample_counts(Firmicutes, function(x){x*100 / sum(x)})

Firmicutes_glom <- tax_glom(ps_rel_phyl, taxrank = "Genus")
Firmicutes_df <- psmelt(Firmicutes_glom )

# # Lump small genera (<10% in any sample) to clarify the plot
Firmicutes_df$Genus[Firmicutes_df$Abundance < 10] <- "Genera < 10.0 abund"
Firmicutes_df$Genus <- as.factor(Firmicutes_df$Genus)

# Color Palette sized to the number of genera
genus_colors_Firmicutes<- colorRampPalette(brewer.pal(8,"Dark2")) (length(levels(Firmicutes_df$Genus)))  

# Stacked bars at Genus level
plot_Firmicutes <- ggplot(data=Firmicutes_df, aes(x=Sample, y=Abundance, fill=Genus))+ geom_bar(aes(), stat="identity", position="stack")+
    scale_fill_manual(values = genus_colors_Firmicutes)

plot_Firmicutes
```

**Questions:**

1.  Explore the composition plot. What did we do to make it visually more clear? (Hint: also check the code)

2.  What are the pros and cons of collapsing to Genus level?

### 2.3 Prevalence–abundance landscape

Instead of focusing only on abundance, we can also measure **prevalence**: in how many samples a taxon is observed. High-prevalence taxa are often “core microbiome” members, while low-prevalence taxa may be contaminants or rare species. This scatterplot helps select a sensible low-prevalence filter.

```{r}

# Storing original relative abundances

otu_rel <- as(otu_table(ps_rel), "matrix")
if (!taxa_are_rows(ps_rel)) otu_rel <- t(otu_rel)

# Calculate prevalence and mean relative abundance
prev <- rowMeans(mat > 0)
mean_rel <- rowMeans(otu_rel)

prev_abund <- data.frame(prevalence = prev, mean_rel_abund = mean_rel)

ggplot(prev_abund, aes(prevalence, mean_rel_abund)) +
  geom_point(alpha = 0.5) +
  scale_y_log10() +
  labs(x = "Prevalence (fraction of samples)",
       y = "Mean relative abundance (log10)",
       title = "Prevalence–abundance landscape")

# Example: keep taxa present in at least 5% of samples
keep <- rowSums(mat > 0) >= ceiling(0.05 * nsamples(ps))
ps_filt <- prune_taxa(keep, ps)
ps_filt
```

**Questions**

1.  Where do most taxa lie on the plot, low prevalence, low abundance? What filter seems reasonable here?
2.  How could an overly aggressive filter bias downstream analyses?

### 2.3.1 Core microbiome (by detection & prevalence)

By combining prevalence and abundance, we can define a **core microbiome**: taxa consistently present across a large fraction of samples. This concept helps identify stable members of the community.

```{r}

core_ids <- core_members(ps_rel, detection = 0.001, prevalence = 0.5)  # ≥0.1% in ≥50% samples
length(core_ids); head(core_ids)

ps_core <- prune_taxa(core_ids, ps_rel)
plot_bar(ps_core, fill = "Phylum") +
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(title = "Core taxa (≥0.1% & ≥50% prevalence)")
```

**Questions**

1.  How many "core" taxa do you get? Which phyla dominate among core taxa?
2.  How might core membership change if you tighten/loosen thresholds? (Try it out by adjusting the code above.)
3.  Why is identifying a core microbiome useful in applied microbiome research (e.g., health, agriculture)?

### 2.4 Top‑N genera view (lump the rest)

Instead of showing all genera, we can focus on the **Top-N most abundant genera** (e.g., Top-10 or Top-20). This makes visualizations clearer and highlights dominant community members, while still illustrating diversity. Rare genera are often grouped into “Other.”

```{r}
set.seed(1)
ps_genus_rel = transform_sample_counts(ps_genus, function(x){x / sum(x)})
dfg <- psmelt(ps_genus_rel)

# Clean empty/NA genus labels
dfg$Genus <- as.character(dfg$Genus)
dfg$Genus[is.na(dfg$Genus) | dfg$Genus == ""] <- "Unclassified"

# Pick top N by mean abundance
topN <- 15
Top <- dfg %>%
  group_by(Genus) %>%
  summarize(mean_abund = mean(Abundance), .groups = "drop") %>%
  arrange(desc(mean_abund)) %>%
  slice_head(n = topN)

dfg$Genus2 <- ifelse(dfg$Genus %in% Top$Genus, dfg$Genus, "Other")

# Optional: order samples by a metadata variable if present (replace 'Group')
# md <- data.frame(sample_data(ps)); md$Sample <- rownames(md)
# ord <- md %>% arrange(Group) %>% pull(Sample)
# dfg$Sample <- factor(dfg$Sample, levels = ord)

ggplot(dfg, aes(x = Sample, y = Abundance, fill = Genus2)) +
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(y = "Relative abundance", title = paste("Top", topN, "genera (others lumped)"))
```

**Questions**

1.  Which genera dominate across samples?
2.  Why might we group rare taxa into “Other” when plotting?
3.  Try different `topN` values, what changes?

### 2.5 Prevalence Filtering

Filtering reduces the number of very rare OTUs/ASVs (potentially spurious) without affecting the abundant taxa that drive community patterns.

```{r}
prevdf = data.frame(Prevalence = prev,
                      TotalAbundance = taxa_sums(ps),
                      tax_table(ps))

prevdf1 = subset(prevdf, Phylum %in% get_taxa_unique(ps, "Phylum"))
ggplot(prevdf1, aes(TotalAbundance, Prevalence / nsamples(ps),color=Phylum)) +
  # Include a guess for parameter
  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) + geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() +  xlab("Total Abundance") + ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Phylum) + theme(legend.position="none")

ps_filt <- filter_taxa(ps, function(x) {
  sum(x > 0) > (0.05 * nsamples(ps)) & sum(x) > 50
}, TRUE)

ps_filt

## --- 1) Define a filtering rule (tweak thresholds as you like)
prev_cut   <- 0.05            # keep taxa present in >5% of samples
abund_cut  <- 50              # keep taxa with >50 total reads across all samples

ps_filt <- filter_taxa(ps, function(x) {
  (sum(x > 0) > prev_cut * nsamples(ps)) & (sum(x) > abund_cut)
}, prune = TRUE)

## --- 2) Quick summary: what did we remove?
n_OTU_before <- ntaxa(ps)
n_OTU_after <- ntaxa(ps_filt)
reads_before <- sum(sample_sums(ps))
reads_after <- sum(sample_sums(ps_filt))

cat(sprintf("OTUs/ASVs: %d → %d (removed %d, %.1f%%)\n",
            n_OTU_before, n_OTU_after, n_OTU_before - n_OTU_after,
            100*(n_OTU_before - n_OTU_after)/n_OTU_before))

cat(sprintf("Reads kept: %.1f%% of total\n", 100*reads_after/reads_before))

## --- 3) Prepare BEFORE & AFTER relative-abundance data at Phylum
to_rel <- function(x) transform_sample_counts(x, function(y) y / sum(y))
ps_rel_before <- tax_glom(to_rel(ps),      taxrank = "Phylum")
ps_rel_after  <- tax_glom(to_rel(ps_filt), taxrank = "Phylum")

df_before <- psmelt(ps_rel_before) %>% mutate(Status = "Before filtering")
df_after  <- psmelt(ps_rel_after)  %>% mutate(Status = "After filtering")

# ## (Optional) collapse very small phyla into "Other" to declutter plots
# min_prop <- 0.01  # show phyla with >=1% mean relative abundance
# keep_phyla <- df_before %>%
#   group_by(Phylum) %>% summarize(meanAbund = mean(Abundance, na.rm=TRUE)) %>%
#   filter(meanAbund >= min_prop) %>% pull(Phylum)
# collapse_small <- function(d) d %>%
#   mutate(Phylum = ifelse(Phylum %in% keep_phyla, as.character(Phylum), "Other"))
# 
# df_before <- collapse_small(df_before)
# df_after  <- collapse_small(df_after)

plot_df <- bind_rows(df_before, df_after)

## --- 4) Side-by-side composition plots (relative abundance by Phylum)
ggplot(plot_df, aes(x = Sample, y = Abundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ Status, ncol = 2, scales = "free_x") +
  labs(x = NULL, y = "Relative abundance", title = "Taxonomic composition at Phylum level: Before vs After filtering") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right")
```

```{r}
# Function to create rank abundance dataframe
make_rank_df <- function(ps, label) {
  df <- data.frame(Abundance = taxa_sums(ps)) %>%
    arrange(desc(Abundance)) %>%
    mutate(Rank = 1:n(),
           Dataset = label)
  return(df)
}

# Create rank-abundance data before and after filtering
rank_before <- make_rank_df(ps, "Before filtering")
rank_after  <- make_rank_df(ps_filt, "After filtering")

rank_df <- rbind(rank_before, rank_after)

# Plot rank-abundance curve
ggplot(rank_df, aes(x = Rank, y = Abundance, color = Dataset)) +
  geom_point(size = 1.2, alpha = 0.7) +
  scale_y_log10() +
  scale_x_log10() +
  labs(title = "Rank-Abundance Curves (Before vs After Filtering)",
       x = "Rank (log scale)",
       y = "Abundance (log scale)") +
  theme_minimal()
```

**Questions:**

1.  Which phyla contain OTUs/ASVs with high prevalence (present in many samples) and high abundance?

2.  Which phyla appear mostly as low-abundance, low-prevalence OTUs/ASVs?

3.  If you had to choose a cutoff for filtering, which regions of this plot would you target?

4.  Why might it be safe to remove rare OTUs/ASVs from low-prevalence phyla, but risky to remove abundant, prevalent OTUs/ASVs?

5.  What do you notice about the beginning of the curve (low-rank OTUs/ASVs, high abundance)?

6.  Where do the “before” and “after filtering” lines diverge?

7.  What does this suggest about which OTUs/ASVs were removed?

8.  Do you think filtering changed the dominant community structure? Why or why not?


# 3. Explore Diversity

## 3.1 Alpha diversity

Alpha diversity describes the biodiversity within a single sample. It can be measured in terms of richness (how many taxa are present) and evenness (how evenly distributed they are). Here, we compute two common indices: Observed richness (number of taxa detected) and Shannon diversity (accounts for both richness and evenness). We then visualize differences in alpha diversity across dietary groups (FoodType), and we test statistically whether groups differ overall.

```{r}
# Alpha diversity indices
alpha_ind <- microbiome::alpha(ps, index = c("observed", "shannon"))
head(alpha_ind)

# Plot with boxplots + jitter + stat test
p_alpha <- plot_richness(ps, x = "FoodType", measures = c("Observed", "Shannon")) +
  geom_boxplot(aes(fill = FoodType), alpha = 0.5, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.6) +
  theme_bw() +
  stat_compare_means(method = "kruskal.test") # global test across groups

p_alpha
```

Questions:

1. Which group (FoodType) has the highest median Shannon diversity?

2. Does Observed richness appear more variable within groups than Shannon diversity?

3. Why is Shannon diversity often more informative than Observed richness? What does it capture that richness alone does not?

4. Based on the Kruskal–Wallis test, is there a statistically significant difference in diversity between groups? If yes, which groups might be driving this?

5. What are some biological or technical reasons that alpha diversity might differ across FoodType groups?

## 3.2 Beta Diversity

Beta diversity describes differences in community composition between samples. Here, we use the Bray–Curtis dissimilarity to quantify how similar or different samples are based on their microbial profiles. We test for group-level differences using PERMANOVA (adonis2), which assesses whether community composition varies significantly with FoodType. Finally, we visualize these distances using Principal Coordinates Analysis (PCoA), which reduces the high-dimensional distance matrix into two axes for easier interpretation

```{r}
dist_bc <- phyloseq::distance(ps_filt, method = "bray")

# PERMANOVA test (adonis2)
meta <- as(sample_data(ps_filt), "data.frame")
adonis_bc <- adonis2(dist_bc ~ FoodType, data = meta)
print(adonis_bc)

# PCoA on Bray–Curtis
ord_bc <- ordinate(ps_filt, method = "PCoA", distance = "bray")

# Plot PCoA
p_pcoa <- plot_ordination(ps_filt, ord_bc, color = "FoodType") +
  geom_point(size = 3, alpha = 0.7) +
  stat_ellipse(aes(color = FoodType), linetype = 2) +
  theme_bw() +
  labs(title = "PCoA - Bray Curtis")

p_pcoa
```

Questions:

1. Do samples from the same FoodType cluster together in the PCoA plot, or are they intermixed?

2. What does it mean if two groups have overlapping ellipses?

3. What do the percentages on the PCoA axes represent, and how should you interpret them?

4. The PERMANOVA test gives you an R² and a p-value. What do these values tell you about the role of FoodType in shaping microbial communities?

5. What assumption of PERMANOVA should you be cautious about (hint: dispersion), and how could you test it?

6. How could you use another distance measure (e.g., UniFrac or Aitchison) to complement Bray–Curtis, and why might this matter biologically?

# F. (Optional) Shiny-app for exploration

Shiny-phyloseq is an interactive web application that provides a graphical user interface to the microbiome analysis package phyloseq.

The following R code will launch Shiny-phyloseq on most systems.

```{r}
# install.packages("shiny")
# shiny::runGitHub("shiny-phyloseq","joey711")
```








